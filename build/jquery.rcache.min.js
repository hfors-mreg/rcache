/*
 * rcache v1.1.1
 * Copyright (c) 2012 Hannes Forsg√•rd <hannes.forsgard@gmail.com>
 * Licensed under the WTFPL (http://sam.zoy.org/wtfpl/)
 */
(function(b){b.rcache=new function(){this.settings={"update-on-read":true,"reset-resource-to":{},"max-size":50};this.setUp=function(c){b.extend(this.settings,c);return this};this.cache={};this.count=function(){var c=0;b.each(this.cache,function(){c++});return c};this.has=function(c){return c in this.cache};this.item=function(c){if(!this.has(c)){this.cache[c]={item:new a(c),time:Date.now()};if(this.count()>this.settings["max-size"]){this.gc()}}this.cache[c].time=Date.now();return this.cache[c].item};this.gc=function(){var f=[];b.each(this.cache,function(g,h){f.push([h.time,g])});f.sort(function(h,g){return h[0]-g[0]});var e=this.settings["max-size"]-Math.round(this.settings["max-size"]/4);for(var d=this.count()-e;d>0;d--){var c=f.shift();this.item(c[1]).remove()}return this};this.clear=function(){this.cache={};return this};this.updateAll=function(c){b.each(this.cache,function(d,e){if(e.item.autoUpdate){e.item.update(c)}});return this};this.ajaxOpts={cache:false};this.ajaxSetup=function(c){b.extend(this.ajaxOpts,c);return this};this.getJqXHR=function(c){var d={};b.extend(d,this.ajaxOpts,c);var e=b.ajax(d);e.fail(function(f){if(f.status==404||f.status==410){b.rcache.item(d.url).remove()}});e.done(function(f,i,g){if(g.status==205){var h=b.rcache.settings["reset-resource-to"];b.rcache.item(d.url).write(h,g)}});return e}};function a(c){this.url=c;this.data=false;this.jqXHR=false;this.autoUpdate=false;this.writeObservers=[];this.removeObservers=[]}a.prototype.hasData=function(){return !!this.data};a.prototype.etag=function(){if(!this.jqXHR){return""}var c=this.jqXHR.getResponseHeader("ETag");return(c)?c:""};a.prototype.modified=function(){if(!this.jqXHR){return""}var c=this.jqXHR.getResponseHeader("Last-Modified");return(c)?c:""};a.prototype.onWrite=function(c){this.writeObservers.push(c);return this};a.prototype.onRemove=function(c){this.removeObservers.push(c);return this};a.prototype.notifyWrite=function(){var c=this;b.each(this.writeObservers,function(d,e){e(c.data,c.etag(),c.modified(),c.jqXHR)});return this};a.prototype.notifyRemove=function(){var c=this;b.each(this.removeObservers,function(d,e){e(c.data,c.etag(),c.modified(),c.jqXHR)});return this};a.prototype.write=function(d,c){this.data=d;this.jqXHR=c;this.autoUpdate=true;this.notifyWrite();return this};a.prototype.remove=function(){this.notifyRemove();delete b.rcache.cache[this.url]};a.prototype.get=function(c){if(this.hasData()&&this.jqXHR){if(b.rcache.settings["update-on-read"]){this.update(c)}return this.jqXHR}else{return this.forceGet(c)}};a.prototype.update=function(c){var f={type:"GET",url:this.url,headers:{"If-None-Match":this.etag(),"If-Modified-Since":this.modified(),}};b.each(f.headers,function(g,h){if(!h){delete f.headers[g]}});b.extend(true,f,c);var e=b.rcache.getJqXHR(f);var d=this;e.done(function(g,h,i){if(i.status==200){d.write(g,i)}});return e};a.prototype.forceGet=function(c){if(!c){c={}}var f={type:"GET",url:this.url,headers:{"If-None-Match":"","If-Modified":"","Cache-Control":"no-cache",Pragma:"no-cache"}};b.extend(true,f,c);var e=b.rcache.getJqXHR(f);var d=this;e.done(function(g,h,i){if(i.status==200){d.write(g,i)}});return e};a.prototype.del=function(c){if(!c){c={}}var f={type:"DELETE",url:this.url,headers:{"If-Match":this.etag(),"If-Unmodified-Since":this.modified(),}};b.each(f.headers,function(g,h){if(!h){delete f.headers[g]}});b.extend(true,f,c);var e=b.rcache.getJqXHR(f);var d=this;e.done(function(g,h,i){if(i.status==200||i.status==204){d.remove()}});return e};a.prototype.put=function(g,c){if(!c){c={}}var f={type:"PUT",url:this.url,data:g,headers:{"If-Match":this.etag(),"If-Unmodified-Since":this.modified(),}};b.each(f.headers,function(h,i){if(!i){delete f.headers[h]}});b.extend(true,f,c);var e=b.rcache.getJqXHR(f);var d=this;e.done(function(h,i,j){if(j.status==200&&h){d.write(h,j)}});return e};a.prototype.post=function(f,c){if(!c){c={}}var e={type:"POST",url:this.url,data:f};b.extend(true,e,c);var d=b.rcache.getJqXHR(e);d.done(function(g,i,k){var j=k.getResponseHeader("Content-Location");var h=k.getResponseHeader("Location");if((k.status==200||k.status==201)&&g&&j){b.rcache.item(j).write(g,k)}else{if(h){b.rcache.item(h).forceGet()}}});return d}})(jQuery);
