/*
 * rcache 1.0.2
 * Copyright (c) 2012 Hannes Forsg√•rd <hannes.forsgard@gmail.com>
 * Licensed under the WTFPL (http://sam.zoy.org/wtfpl/)
 */
(function(b){b.rcache=new function(){this.settings={"update-on-read":true,"reset-resource-to":{},};this.setUp=function(c){b.extend(this.settings,c);return this};this.cache={};this.count=function(){var c=0;b.each(this.cache,function(){c++});return c};this.has=function(c){return c in this.cache};this.item=function(c){if(!this.has(c)){this.cache[c]=new a(c)}return this.cache[c]};this.clear=function(){this.cache={};return this};this.updateAll=function(c){b.each(this.cache,function(d,e){if(e.autoUpdate){e.update(c)}});return this};this.ajaxOpts={cache:false};this.ajaxSetup=function(c){b.extend(this.ajaxOpts,c);return this};this.getJqXHR=function(c){var d={};b.extend(d,this.ajaxOpts,c);var e=b.ajax(d);e.fail(function(f){if(f.status==404||f.status==410){b.rcache.item(d.url).remove()}});e.done(function(f,i,g){if(g.status==205){var h=b.rcache.settings["reset-resource-to"];b.rcache.item(d.url).write(h,g)}});return e}};function a(c){this.url=c;this.data=false;this.jqXHR=false;this.autoUpdate=false;this.writeCallbacks=[];this.removeCallbacks=[];this.hasData=function(){return !!this.data};this.etag=function(){if(!this.jqXHR){return""}var d=this.jqXHR.getResponseHeader("ETag");return(d)?d:""};this.modified=function(){if(!this.jqXHR){return""}var d=this.jqXHR.getResponseHeader("Last-Modified");return(d)?d:""};this.onWrite=function(d){this.writeCallbacks.push(d);return this};this.onRemove=function(d){this.removeCallbacks.push(d);return this};this.triggerWrite=function(){var d=this;b.each(this.writeCallbacks,function(e,f){f(d.data,d.etag(),d.modified(),d.jqXHR)});return this};this.triggerRemove=function(){var d=this;b.each(this.removeCallbacks,function(e,f){f(d.data,d.etag(),d.modified(),d.jqXHR)});return this};this.write=function(e,d){this.data=e;this.jqXHR=d;this.autoUpdate=true;this.triggerWrite();return this};this.remove=function(){this.triggerRemove();delete b.rcache.cache[this.url]};this.get=function(d){if(this.hasData()&&this.jqXHR){if(b.rcache.settings["update-on-read"]){this.update(d)}return this.jqXHR}else{return this.forceGet(d)}};this.update=function(d){var g={type:"GET",url:this.url,headers:{"If-None-Match":this.etag(),"If-Modified-Since":this.modified(),}};b.each(g.headers,function(h,i){if(!i){delete g.headers[h]}});b.extend(true,g,d);var f=b.rcache.getJqXHR(g);var e=this;f.done(function(h,i,j){if(j.status==200){e.write(h,j)}});return f};this.forceGet=function(d){if(!d){d={}}var g={type:"GET",url:this.url,headers:{"If-None-Match":"","If-Modified":"","Cache-Control":"no-cache",Pragma:"no-cache"}};b.extend(true,g,d);var f=b.rcache.getJqXHR(g);var e=this;f.done(function(h,i,j){if(j.status==200){e.write(h,j)}});return f};this.del=function(d){if(!d){d={}}var g={type:"DELETE",url:this.url,headers:{"If-Match":this.etag(),"If-Unmodified-Since":this.modified(),}};b.each(g.headers,function(h,i){if(!i){delete g.headers[h]}});b.extend(true,g,d);var f=b.rcache.getJqXHR(g);var e=this;f.done(function(h,i,j){if(j.status==200){e.remove()}});return f};this.put=function(h,d){if(!d){d={}}var g={type:"PUT",url:this.url,data:h,headers:{"If-Match":this.etag(),"If-Unmodified-Since":this.modified(),}};b.each(g.headers,function(i,j){if(!j){delete g.headers[i]}});b.extend(true,g,d);var f=b.rcache.getJqXHR(g);var e=this;f.done(function(i,j,k){if(k.status==200&&i){e.write(i,k)}});return f};this.post=function(g,d){if(!d){d={}}var f={type:"POST",url:this.url,data:g};b.extend(true,f,d);var e=b.rcache.getJqXHR(f);e.done(function(h,j,l){var k=l.getResponseHeader("Content-Location");var i=l.getResponseHeader("Location");if((l.status==200||l.status==201)&&h&&k){b.rcache.item(k).write(h,l)}else{if(i){b.rcache.item(i).forceGet()}}});return e}}})(jQuery);
